<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wormhole</title>
</head>
<body>
  <script>
    // const LOCAL_URL = "ws://localhost:4455";
    const LOCAL_URL = "ws://localhost:55001";
    const WORMHOLE_URL = "ws://localhost:55000";

    class HostController {
      wormhole
      localURL
      pipes = new Map()

      constructor(wormholeURL = WORMHOLE_URL, localURL = LOCAL_URL) {
        this.localURL = localURL;

        this.wormhole = new WebSocket(wormholeURL, "awful.cooking/wormhole");
        this.wormhole.addEventListener("open", () => {
          console.debug("Connected to wormhole server");
        });
        this.wormhole.addEventListener("message", this.handleMessage);
        this.wormhole.addEventListener("close", (ex) => {
          console.debug("Disconnected from wormhole server", ex);
        });
      }

      handleMessage = async (event) => {
        console.debug("Received message", event.data);
        const { pipeID, state, data, dataType, subprotocol, meta } = JSON.parse(event.data);

        if (state === "pending") {
          this.openPipe(pipeID, subprotocol);
        } else if (state === "closed") {
          this.closePipe(pipeID);
        } else if (data) {
          this.writePipe(pipeID, data, dataType);
        } else if (meta) {
          console.info("Got slug", meta.slug);
          this.slug = meta.slug;
        } else {
          console.warn("Alien message from wormhole", event.data);
        }
      }

      send(msg) {
        console.debug("Send to control", msg);
        this.wormhole.send(JSON.stringify(msg));
      }

      openPipe(pipeID, subprotocol) {
        const pipe = new WebSocket(this.localURL, subprotocol);
        this.pipes.set(pipeID, pipe);

        pipe.addEventListener("open", () => {
          this.send({ pipeID, state: "opened" });
        });

        pipe.addEventListener("close", (e) => {
          console.info("Downstream disconnected", e)
          this.send({ pipeID, state: "closed" });
        });

        pipe.addEventListener("error", () => {
          this.send({ pipeID, state: "error" });
        });

        pipe.addEventListener("message", (event) => {
          console.debug("msg from dwonstream", event)
          this.send({ pipeID, data: event.data, dataType: 0 });
        });
      }

      closePipe(id) {
        this.pipes.get(id).close();
        // sendToControl({ pipeID, state: "closed" });
      }
      
      writePipe(id, data, dataType) {
        const { socket } = this.pipes.get(id);
        if (dataType !== 0) {
          console.error("unrecognised data type", dataType);
          return;
        }
        socket.send(data);
      }
    }

    class PipeExistsError extends Error {};
    class PipeNotFoundError extends Error {};
  </script>

  <script>
    const controller = new HostController();
  </script>
</body>
</html>
